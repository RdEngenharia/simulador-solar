<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulador Solar | RD Engenharia Elétrica</title>
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Bibliotecas para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; background: #f2f6fa; padding: 20px; }
    .box { max-width: 460px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .logo { text-align: center; }
    .logo img { max-width: 150px; display:block; margin:auto; }
    input, select, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; box-sizing: border-box; }
    button { border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; }
    button.simular { background: #0a7cff; color:#fff; }
    button.whatsapp { background: #25d366; color:#fff; }
    button.pdf { background: #e74c3c; color:#fff; display: none; margin-top: 10px; }
    .resultado { margin-top: 15px; font-size: 14px; }
    .aviso { font-size: 12px; color: #555; margin-top:8px; }
    .item { display:flex; align-items:center; margin-bottom:8px; }
    .item i { color:#0a7cff; margin-right:8px; width:20px; text-align:center; }
    .financiamento { margin-top:10px; font-size:14px; color:#d35400; }
    .economia { color:#27ae60; font-weight:bold; }
    .retorno { color:#e67e22; font-weight:bold; }
    .carencia { font-style:italic; font-size:12px; color:#c0392b; margin-left:5px; }
    #loading { display:none; text-align:center; color:#e74c3c; font-weight:bold; margin-top:10px; }
    .validade-info { font-weight: bold; color: #c0392b; margin-top: 5px; display: block; }
  </style>
</head>
<body>
  <div class="box">
    <div class="logo">
      <img src="logo.png" alt="RD Engenharia" onerror="this.style.display='none'">
    </div>
    <h3>Simulador de Energia Solar</h3>
    <input type="text" id="nome" placeholder="Nome do cliente">
    <select id="padrao">
      <option value="">Tipo de padrão</option>
      <option value="mono">Monofásico</option>
      <option value="bi">Bifásico</option>
      <option value="tri">Trifásico</option>
    </select>
    <input type="number" id="conta" placeholder="Valor da conta de luz (R$)">
    
    <button class="simular" onclick="simular()">
      <i class="fas fa-solar-panel"></i> Simular
    </button>
    
    <div id="loading">Gerando PDF...</div>
    
    <div class="resultado" id="resultado"></div>
    
    <button id="btnPDF" class="pdf" onclick="gerarPDF()">
      <i class="fas fa-file-pdf"></i> Baixar Proposta PDF
    </button>

    <a id="btnWhats" href="#" target="_blank" style="text-decoration: none;">
      <button class="whatsapp"><i class="fab fa-whatsapp"></i> Falar no WhatsApp</button>
    </a>
  </div>

<script>
let dadosPDF = {};
const WHATSAPP_NUMBER = "73991317853";

function formatBR(valor) {
  let n = Number(valor).toFixed(2);
  let partes = n.split('.');
  partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return partes.join(',');
}

function simular() {
  const nome = document.getElementById("nome").value.trim();
  const padrao = document.getElementById("padrao").value;
  const conta = Number(document.getElementById("conta").value);

  if(!nome || !padrao || conta <= 0){
    alert("Preencha todos os campos corretamente.");
    return;
  }

  const valorKwh = 1.20; 
  const taxaInjecao = 0.19;
  const consumoSimultaneo = 0.5;
  const geracaoPainel = 70;

  const consumoMedio = conta / valorKwh;
  const taxaMinima = padrao === "mono" ? 32 : padrao === "bi" ? 50 : 90;

  const kits = [
    {paineis: 4, valor: 7500},
    {paineis: 6, valor: 10000},
    {paineis: 8, valor: 12000},
    {paineis: 10, valor: 14000},
    {paineis: 12, valor: 16000},
    {paineis: 14, valor: 19000}
  ];

  let paineisEscolhidos = kits.find(k => k.paineis >= Math.ceil(consumoMedio / geracaoPainel));

  if(!paineisEscolhidos){
    document.getElementById("resultado").innerHTML = `<b>Consumo muito alto para simulação.</b><br>Entre em contato pelo WhatsApp para orçamento.`;
    document.getElementById("btnWhats").href = `https://wa.me/${WHATSAPP_NUMBER}?text=Olá! Preciso de orçamento para consumo acima de 14 painéis.`;
    return;
  }

  const paineis = paineisEscolhidos.paineis;
  const valorKit = paineisEscolhidos.valor;
  const geracaoMensal = paineis * geracaoPainel;
  const consumoInstantaneo = geracaoMensal * consumoSimultaneo;
  const energiaCompensada = geracaoMensal - consumoInstantaneo;
  const taxaPorInjecao = energiaCompensada * taxaInjecao;
  const contaPosSolar = Math.max(taxaPorInjecao, taxaMinima);
  const economiaMensal = conta - contaPosSolar;
  const retorno = (valorKit / (economiaMensal * 12)).toFixed(1);

  let economia25 = 0;
  for(let i=0;i<25;i++){
    economia25 += economiaMensal*12*Math.pow(1.02,i);
  }
  economia25 = economia25.toFixed(2);

  let parcelas = [];
  switch(valorKit){
    case 7500: parcelas=[{q:12,v:837.48},{q:36,v:384.20},{q:48,v:333.43},{q:60,v:305.87}]; break;
    case 10000: parcelas=[{q:12,v:1116.64},{q:36,v:512.33},{q:48,v:445.40},{q:60,v:408.25}]; break;
    case 12000: parcelas=[{q:12,v:1339.97},{q:36,v:616.40},{q:48,v:534.48},{q:60,v:489.39}]; break;
    case 14000: parcelas=[{q:12,v:1563.97},{q:36,v:716.13},{q:48,v:622.12},{q:60,v:569.70}]; break;
    case 16000: parcelas=[{q:12,v:1782.60},{q:36,v:815.00},{q:48,v:710.00},{q:60,v:650.00}]; break;
    case 19000: parcelas=[{q:12,v:2124.90},{q:36,v:974.60},{q:48,v:847.20},{q:60,v:775.50}]; break;
  }

  const padraoTexto = padrao==='mono'?'Monofásico':padrao==='bi'?'Bifásico':'Trifásico';

  dadosPDF = {nome, padrao: padraoTexto, conta, paineis, valorKit, contaPosSolar, economiaMensal, retorno, economia25, parcelas, geracaoMensal, consumoMedio};

  let financHTML = "<div class='financiamento'><b>Simulação de financiamento:</b> <span class='carencia'>(carência de até 90 dias)</span><br>";
  parcelas.forEach(p => { financHTML += `<i class="fas fa-credit-card"></i> ${p.q}x de R$ ${formatBR(p.v)}<br>`; });
  financHTML += "</div>";

  document.getElementById("resultado").innerHTML = `
    <div class="item"><i class="fas fa-user"></i> <b>Cliente:</b> ${nome}</div>
    <div class="item"><i class="fas fa-bolt"></i> <b>Padrão:</b> ${padraoTexto}</div>
    <div class="item"><i class="fas fa-bolt"></i> <b>Consumo médio mensal:</b> ${formatBR(consumoMedio)} kWh</div>
    <div class="item"><i class="fas fa-solar-panel"></i> <b>Kit indicado:</b> ${paineis} painéis de 570W (Geração estimada/mês: ${formatBR(geracaoMensal)} kWh)</div>
    <div class="item"><i class="fas fa-money-bill-wave"></i> <b>Valor à vista:</b> R$ ${formatBR(valorKit)}</div>
    ${financHTML}
    <div class="item economia"><i class="fas fa-file-invoice-dollar"></i> <b>Conta após instalação:</b> R$ ${formatBR(contaPosSolar)}</div>
    <div class="item economia"><i class="fas fa-hand-holding-usd"></i> <b>Economia mensal:</b> R$ ${formatBR(economiaMensal)}</div>
    <div class="item retorno"><i class="fas fa-chart-line"></i> <b>Retorno do investimento:</b> ${retorno} anos</div>
    <div class="item retorno"><i class="fas fa-calendar-alt"></i> <b>Economia estimada em 25 anos:</b> R$ ${formatBR(economia25)}</div>
    <div class="aviso">* Simulação parcial. Valores podem variar conforme consumo e análise do banco.</div>
    <div class="aviso validade-info"><i class="fas fa-clock"></i> Orçamento válido por 5 dias.</div>
  `;

  document.getElementById("btnPDF").style.display = "flex";
  document.getElementById("btnWhats").href = `https://wa.me/${WHATSAPP_NUMBER}?text=Olá! Fiz uma simulação solar.%0ANome:${nome}%0APadrão:${padraoTexto}%0AKit:${paineis} painéis`;
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const d = dadosPDF;
  const azul = [10, 124, 255];
  const verde = [39, 174, 96];

  // Cabeçalho
  doc.setFontSize(20);
  doc.setTextColor(azul[0], azul[1], azul[2]);
  doc.text("RD ENGENHARIA ELÉTRICA", 105, 20, { align: "center" });
  
  doc.setFontSize(12);
  doc.setTextColor(100);
  doc.text("PROPOSTA TÉCNICA COMERCIAL", 105, 28, { align: "center" });
  doc.line(20, 32, 190, 32);

  // Dados do Cliente
  doc.setFontSize(10);
  doc.setTextColor(0);
  doc.text(`CLIENTE: ${d.nome.toUpperCase()}`, 20, 42);
  doc.text(`PADRÃO DE ENTRADA: ${d.padrao.toUpperCase()}`, 20, 48);
  doc.text(`DATA: ${new Date().toLocaleDateString('pt-BR')}`, 160, 42);
  doc.setTextColor(192, 57, 43); 
  doc.text(`VALIDADE: 5 DIAS`, 160, 48);

  // Seção de Equipamentos e Serviços
  doc.setFontSize(12);
  doc.setTextColor(azul[0], azul[1], azul[2]);
  doc.text("EQUIPAMENTOS E SERVIÇOS INCLUSOS", 20, 60);
  
  doc.setFontSize(10);
  doc.setTextColor(0);
  doc.text(`• ${d.paineis} Módulos Fotovoltaicos 570Wp de Alta Eficiência.`, 20, 68);
  doc.text("• Inversor Solar com Monitoramento Wi-Fi.", 20, 74);
  doc.text("• Instalação Técnica Completa.", 20, 80);
  doc.text("• Homologação junto à Concessionária de Energia.", 20, 86);

  // Tabela de Viabilidade
  doc.autoTable({
    startY: 95,
    head: [['DESCRIÇÃO DO PROJETO', 'VALORES']],
    body: [
      ['Geração Mensal Esperada', `${formatBR(d.geracaoMensal)} kWh`],
      ['Investimento Total', `R$ ${formatBR(d.valorKit)}`],
      ['Conta após Instalação (Estimada)', `R$ ${formatBR(d.contaPosSolar)}`],
      ['Economia Mensal Estimada', `R$ ${formatBR(d.economiaMensal)}`],
      ['Payback (Retorno)', `${d.retorno} Anos`],
      ['Economia Total (25 Anos)', `R$ ${formatBR(d.economia25)}`],
    ],
    headStyles: { fillColor: azul }
  });

  // Financiamento
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 10,
    head: [['OPÇÕES DE FINANCIAMENTO (SIMULAÇÃO)', 'PARCELA']],
    body: d.parcelas.map(p => [`Crédito Solar ${p.q} meses`, `R$ ${formatBR(p.v)}`]),
    headStyles: { fillColor: verde },
    foot: [['Observação: Carência de até 90 dias para começar a pagar.', '']],
    footStyles: { fillColor: [245, 245, 245], textColor: [100, 100, 100], fontStyle: 'italic', fontSize: 8 }
  });

  // Lista de Benefícios
  const finalY = doc.lastAutoTable.finalY + 15;
  doc.setFontSize(13);
  doc.setTextColor(azul[0], azul[1], azul[2]);
  doc.text("BENEFÍCIOS DO PROJETO", 20, finalY);
  
  doc.setFontSize(12);
  doc.setTextColor(50);
  doc.text("1. Valorização imediata do seu patrimônio.", 25, finalY + 10);
  doc.text("2. Imunidade contra reajustes de tarifas de energia.", 25, finalY + 18);
  doc.text("3. Equipamentos com garantia de eficiência de 25 anos.", 25, finalY + 26);
  doc.text("4. Controle total da geração através de aplicativo.", 25, finalY + 34);

  // Link para WhatsApp (Substituindo o selo)
  const contactY = 265;
  doc.setFontSize(11);
  doc.setTextColor(verde[0], verde[1], verde[2]);
  doc.text("FALE CONOSCO PELO WHATSAPP:", 105, contactY, { align: "center" });
  
  doc.setFontSize(14);
  doc.text("(73) 99131-7853", 105, contactY + 8, { align: "center" });
  
  // Cria o link invisível sobre o texto do número
  const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=Olá! Gostaria de falar sobre a proposta solar.`;
  doc.link(75, contactY + 2, 60, 10, { url: whatsappUrl });

  // Rodapé textual
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.text("RD Engenharia Elétrica | CNPJ: 44.367.932/0001-42", 105, 285, { align: "center" });

  doc.save(`Proposta_Solar_${d.nome}.pdf`);
}
</script>
</body>
</html>